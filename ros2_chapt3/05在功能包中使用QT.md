# 05 在功能包中使用 Qt

## 1. 概述

本节学习如何在 ROS2 功能包中集成 Qt6，创建一个简单的图形界面程序。

---

## 2. 环境准备

### 2.1 安装 Qt6 开发库

```bash
sudo apt install qt6-base-dev
```

### 2.2 安装 Wayland 支持（可选，解决平台插件问题）

```bash
sudo apt install qt6-wayland
```

---

## 3. 代码详解：hello_qt.cpp

```cpp
#include <QApplication>  // Qt 应用程序核心类
#include <QLabel>        // 标签控件，用于显示文本
#include <QString>       // Qt 字符串类

int main(int argc, char** argv) {
    // 创建 Qt 应用程序对象
    // 注意：argc 必须是引用类型，argv 不能是 const
    QApplication a(argc, argv);

    // 创建标签控件
    QLabel* label = new QLabel();

    // 使用 QString::fromStdString 将 std::string 转换为 QString
    QString message = QString::fromStdString("Hello Qt6");

    // 设置标签显示的文本
    label->setText(message);

    // 显示标签窗口
    label->show();

    // 进入 Qt 事件循环，程序在此阻塞，等待用户交互
    a.exec();

    return 0;
}
```

### 3.1 关键知识点

| 组件 | 说明 |
|------|------|
| `QApplication` | Qt 应用程序的入口，管理 GUI 程序的控制流和主要设置 |
| `QLabel` | 用于显示文本或图片的控件 |
| `QString` | Qt 的字符串类，支持 Unicode，与 `std::string` 相互转换 |
| `exec()` | 启动事件循环，让程序响应用户操作（点击、键盘等） |

### 3.2 注意事项

**main 函数参数类型必须正确：**
```cpp
// 正确 ✓
int main(int argc, char** argv)

// 错误 ✗ - QApplication 不接受 const char**
int main(int argc, const char** argv)
```

原因：Qt 可能会修改命令行参数（移除 Qt 特定的参数如 `-style`、`-platform` 等）。

---

## 4. CMakeLists.txt 配置详解

```cmake
cmake_minimum_required(VERSION 3.8)
project(status_display)

# 编译器警告选项
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# ========== 依赖查找 ==========
find_package(ament_cmake REQUIRED)      # ROS2 ament 构建系统
find_package(rclcpp REQUIRED)           # ROS2 C++ 客户端库
find_package(status_interface REQUIRED) # 自定义接口包
find_package(Qt6 REQUIRED COMPONENTS Widgets)  # 【关键】查找 Qt6 Widgets 模块

# ========== 构建可执行文件 ==========
add_executable(hello_qt src/hello_qt.cpp)

# 【关键】链接 Qt6 Widgets 库
target_link_libraries(hello_qt Qt6::Widgets)

# ========== 安装配置 ==========
# 【关键】将可执行文件安装到 ROS2 能找到的位置
install(TARGETS hello_qt
  DESTINATION lib/${PROJECT_NAME}
)

# 测试配置（可选）
if(BUILD_TESTING)
  find_package(ament_lint_auto REQUIRED)
  set(ament_cmake_copyright_FOUND TRUE)
  set(ament_cmake_cpplint_FOUND TRUE)
  ament_lint_auto_find_test_dependencies()
endif()

ament_package()
```

### 4.1 Qt 相关的关键配置

| 配置项 | 说明 |
|--------|------|
| `find_package(Qt6 REQUIRED COMPONENTS Widgets)` | 查找 Qt6，加载 Widgets 组件 |
| `target_link_libraries(hello_qt Qt6::Widgets)` | 将 Qt6::Widgets 链接到目标 |
| `install(TARGETS ...)` | 安装可执行文件，否则 `ros2 run` 找不到 |

### 4.2 Qt6 常用组件

| 组件 | 用途 |
|------|------|
| `Widgets` | 传统桌面 GUI 控件（按钮、标签、窗口等） |
| `Core` | 核心非 GUI 功能（自动包含） |
| `Gui` | GUI 基础功能（自动包含） |
| `Quick` | QML 快速开发 |
| `Network` | 网络功能 |

---

## 5. 编译与运行

### 5.1 编译

```bash
cd ~/ros2_chapt3/topic_pra_ws
colcon build --packages-select status_display
```

### 5.2 加载环境

```bash
source install/setup.bash
```

### 5.3 运行

```bash
ros2 run status_display hello_qt
```

### 5.4 常见问题

**问题：`Could not find the Qt platform plugin "wayland"`**

解决方案：
```bash
# 方案1：安装 Wayland 插件（推荐）
sudo apt install qt6-wayland

# 方案2：强制使用 X11
QT_QPA_PLATFORM=xcb ros2 run status_display hello_qt
```

---

## 6. 总结

在 ROS2 功能包中使用 Qt 的核心步骤：

1. **安装依赖**：`sudo apt install qt6-base-dev`
2. **CMakeLists.txt 配置**：
   - `find_package(Qt6 REQUIRED COMPONENTS Widgets)`
   - `target_link_libraries(<target> Qt6::Widgets)`
   - `install(TARGETS <target> DESTINATION lib/${PROJECT_NAME})`
3. **代码编写**：注意 `main` 函数参数类型
4. **编译运行**：`colcon build` → `source` → `ros2 run`

---

## 7. 扩展阅读

- [Qt6 官方文档](https://doc.qt.io/qt-6/)
- [ROS2 与 Qt 集成最佳实践](https://docs.ros.org/en/humble/Tutorials.html)
