# ROS2 自定义消息接口

## 1. msg 在哪里创建？

在**功能包根目录**下创建 `msg/` 文件夹：

```
status_interface/          ← 功能包根目录
├── CMakeLists.txt
├── package.xml
└── msg/                   ← 在这里创建！
    └── SystemStatus.msg   ← 消息文件放这里
```

---

## 2. 创建接口功能包

使用 `ros2 pkg create` 命令创建功能包：

```bash
cd ~/ros2_ws/src
ros2 pkg create --build-type ament_cmake <包名>_interface
```

- `--build-type ament_cmake` → 使用 CMake 构建（接口包必须用这个）
- 命名习惯：专门放消息的包通常叫 `xxx_interface` 或 `xxx_msgs`

---

## 3. 消息文件示例

`msg/SystemStatus.msg`：

```
builtin_interfaces/Time stamp    # 时间戳
string host_name                 # 主机名
float32 cpu_percent              # CPU使用率
float32 memory_percent           # 内存使用率
float32 memory_total             # 总内存
float32 memory_available         # 可用内存
float64 net_sent                 # 网络发送
float64 net_recv                 # 网络接收
```

---

## 4. `<depend>builtin_interfaces</depend>` 是什么？

声明**依赖 ROS2 内置数据类型**。

当消息文件中使用了 `builtin_interfaces` 包的类型时需要添加：

```
builtin_interfaces/Time stamp   ← 用到了 builtin_interfaces 包的 Time 类型
```

**常用的 builtin_interfaces 类型**：

| 类型 | 说明 |
|------|------|
| `Time` | 时间戳 |
| `Duration` | 时间间隔 |

> 如果 `.msg` 文件只用基础类型（string, int32, float64等），就**不需要**这个依赖。

---

## 5. `rosidl_generate_interfaces` 是什么？

**把 .msg 文件编译成代码**的核心命令：

```cmake
rosidl_generate_interfaces(${PROJECT_NAME}
  "msg/SystemStatus.msg"           # 要编译的消息文件
  DEPENDENCIES builtin_interfaces  # 依赖的其他接口包
)
```

作用：

```
SystemStatus.msg  ──编译──→  Python类 + C++类
                              ↓
                   可以在代码里 import 使用！
```

---

## 6. 配置文件

### package.xml

```xml
<?xml version="1.0"?>
<package format="3">
  <name>status_interface</name>
  <version>0.0.0</version>
  <description>系统状态消息接口</description>
  <maintainer email="your@email.com">your_name</maintainer>
  <license>Apache-2.0</license>

  <member_of_group>rosidl_interface_packages</member_of_group>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <depend>builtin_interfaces</depend>
  <depend>rosidl_default_generators</depend>

  <test_depend>ament_lint_auto</test_depend>
  <test_depend>ament_lint_common</test_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

关键配置说明：
- `<member_of_group>rosidl_interface_packages</member_of_group>` → 声明这是一个接口包
- `<depend>rosidl_default_generators</depend>` → 消息生成器依赖

### CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.8)
project(status_interface)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# 查找依赖
find_package(ament_cmake REQUIRED)
find_package(builtin_interfaces REQUIRED)
find_package(rosidl_default_generators REQUIRED)

# 生成消息接口
rosidl_generate_interfaces(${PROJECT_NAME}
  "msg/SystemStatus.msg"
  DEPENDENCIES builtin_interfaces
)

ament_package()
```

---

## 7. 编译与验证

### 编译

```bash
cd ~/ros2_ws
colcon build --packages-select status_interface
source install/setup.bash
```

### 验证

```bash
# 查看消息定义
ros2 interface show status_interface/msg/SystemStatus
```

---

## 8. 使用自定义消息

### Python

```python
from status_interface.msg import SystemStatus

msg = SystemStatus()
msg.host_name = "my_robot"
msg.cpu_percent = 50.0
msg.memory_percent = 60.0
```

### C++

```cpp
#include "status_interface/msg/system_status.hpp"

status_interface::msg::SystemStatus msg;
msg.host_name = "my_robot";
msg.cpu_percent = 50.0;
msg.memory_percent = 60.0;
```

---

## 总结

| 步骤 | 内容 |
|------|------|
| 1. 创建包 | `ros2 pkg create --build-type ament_cmake xxx_interface` |
| 2. 创建 msg 目录 | 在包根目录下创建 `msg/` 文件夹 |
| 3. 编写 .msg 文件 | 定义消息字段和类型 |
| 4. 配置 package.xml | 添加 rosidl_default_generators 依赖 |
| 5. 配置 CMakeLists.txt | 使用 rosidl_generate_interfaces |
| 6. 编译 | `colcon build --packages-select xxx_interface` |
| 7. 使用 | import 或 include 后即可使用 |
