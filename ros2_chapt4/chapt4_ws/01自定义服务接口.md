# ROS2 自定义服务接口学习笔记

## 目录

- [一、ROS2 接口的三种类型](#一ros2-接口的三种类型)
- [二、接口文件的组成](#二接口文件的组成)
  - [2.1 srv 文件结构](#21-srv-文件结构)
  - [2.2 支持的基本类型](#22-支持的基本类型)
- [三、创建接口包的完整步骤](#三创建接口包的完整步骤)
  - [3.1 创建专门的接口包](#31-创建专门的接口包)
  - [3.2 创建接口文件夹和文件](#32-创建接口文件夹和文件)
  - [3.3 编写接口文件](#33-编写接口文件)
- [四、CMakeLists.txt 配置详解](#四cmakeliststxt-配置详解)
- [五、package.xml 配置详解](#五packagexml-配置详解)
- [六、编译和使用](#六编译和使用)
- [七、在其他包中使用自定义消息](#七在其他包中使用自定义消息)
- [八、关于 sensor_msgs/Image](#八关于-sensor_msgsimage)
- [九、服务的工作流程](#九服务的工作流程)
  - [9.1 服务端（Server）](#91-服务端server)
  - [9.2 客户端（Client）](#92-客户端client)
  - [9.3 完整流程图](#93-完整流程图)
- [十、srv 文件的本质作用](#十srv-文件的本质作用)

---

## 一、ROS2 接口的三种类型

ROS2 有三种接口类型，用于不同的通信场景：

| 类型 | 文件后缀 | 用途 | 通俗比喻 |
|------|---------|------|----------|
| **msg** | `.msg` | 话题消息（单向发布） | 像广播电台，说完就完了 |
| **srv** | `.srv` | 服务（请求-响应） | 像打电话，一问一答 |
| **action** | `.action` | 动作（带反馈的长任务） | 像点外卖，能看到配送进度 |

---

## 二、接口文件的组成

### 2.1 srv 文件结构

以 `FaceDetector.srv` 为例：

```
sensor_msgs/Image image    # 请求部分：发送一张图片
---                        # 分隔符（srv 专用）
int16 number               # 响应部分：检测到的人脸数量
float32 use_time           # 响应部分：处理耗时
int32[] top                # 响应部分：人脸边框坐标
int32[] right
int32[] bottom
int32[] left
```

**语法规则**：
```
类型 字段名
```

### 2.2 支持的基本类型

| 类型 | 说明 |
|------|------|
| `bool` | 布尔值 |
| `int8/16/32/64` | 有符号整数 |
| `uint8/16/32/64` | 无符号整数 |
| `float32/64` | 浮点数 |
| `string` | 字符串 |
| `类型[]` | 动态数组（如 `int32[]`） |
| `类型[N]` | 固定长度数组（如 `float64[3]`） |
| `其他消息类型` | 如 `sensor_msgs/Image` |

---

## 三、创建接口包的完整步骤

### 3.1 创建专门的接口包

```bash
cd ~/ros2_ws/src
ros2 pkg create your_interface --build-type ament_cmake
```

> **为什么要单独建包？** 接口包只放接口定义，不放代码，这样其他包都能依赖它。

### 3.2 创建接口文件夹和文件

```
your_interface/
├── msg/              # 放 .msg 文件
├── srv/              # 放 .srv 文件
│   └── FaceDetector.srv
├── action/           # 放 .action 文件
├── CMakeLists.txt
└── package.xml
```

### 3.3 编写接口文件

**msg 文件示例** (`msg/PersonInfo.msg`)：
```
string name
int32 age
float32 height
```

**srv 文件示例** (`srv/FaceDetector.srv`)：
```
sensor_msgs/Image image
---
int16 number
float32 use_time
int32[] top
int32[] right
int32[] bottom
int32[] left
```

**action 文件格式**（参考）：
```
# 目标
---
# 结果
---
# 反馈
```

---

## 四、CMakeLists.txt 配置详解

```cmake
cmake_minimum_required(VERSION 3.8)
project(chapt4_interface)

if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "Clang")
  add_compile_options(-Wall -Wextra -Wpedantic)
endif()

# ========== 关键依赖 ==========
find_package(ament_cmake REQUIRED)
find_package(sensor_msgs REQUIRED)           # 因为用到了 sensor_msgs/Image
find_package(rosidl_default_generators REQUIRED)  # 【必须】接口生成器

# ========== 生成接口 ==========
rosidl_generate_interfaces(${PROJECT_NAME}
  "srv/FaceDetector.srv"     # 列出所有接口文件
  # "msg/PersonInfo.msg"     # 如果有 msg 也加在这里
  DEPENDENCIES sensor_msgs    # 声明依赖的其他消息包
)

ament_package()
```

**核心要点**：

| 配置项 | 作用 |
|--------|------|
| `find_package(rosidl_default_generators REQUIRED)` | 必须！这是生成接口代码的工具 |
| `rosidl_generate_interfaces()` | 告诉构建系统要生成哪些接口 |
| `DEPENDENCIES` | 如果引用了其他包的消息类型，要在这里声明 |

---

## 五、package.xml 配置详解

```xml
<?xml version="1.0"?>
<package format="3">
  <name>chapt4_interface</name>
  <version>0.0.0</version>
  <description>自定义接口包</description>
  <maintainer email="your@email.com">your_name</maintainer>
  <license>Apache-2.0</license>

  <buildtool_depend>ament_cmake</buildtool_depend>

  <!-- 【关键1】声明这是一个接口包 -->
  <member_of_group>rosidl_interface_packages</member_of_group>

  <!-- 【关键2】接口生成器依赖 -->
  <depend>rosidl_default_generators</depend>

  <!-- 【关键3】如果用到其他消息包 -->
  <depend>sensor_msgs</depend>

  <test_depend>ament_lint_auto</test_depend>
  <test_depend>ament_lint_common</test_depend>

  <export>
    <build_type>ament_cmake</build_type>
  </export>
</package>
```

**三个关键配置**：

| 配置 | 作用 |
|------|------|
| `<member_of_group>rosidl_interface_packages</member_of_group>` | 告诉 ROS2 这是接口包 |
| `<depend>rosidl_default_generators</depend>` | 依赖接口生成工具 |
| `<depend>sensor_msgs</depend>` | 依赖引用的消息包 |

---

## 六、编译和使用

```bash
# 编译接口包
cd ~/ros2_ws
colcon build --packages-select chapt4_interface

# 刷新环境
source install/setup.bash

# 查看生成的接口
ros2 interface show chapt4_interface/srv/FaceDetector
```

---

## 七、在其他包中使用自定义消息

**package.xml** 添加依赖：
```xml
<depend>chapt4_interface</depend>
```

**CMakeLists.txt** 添加：
```cmake
find_package(chapt4_interface REQUIRED)
ament_target_dependencies(你的节点名 chapt4_interface)
```

**Python 代码中导入**：
```python
from chapt4_interface.srv import FaceDetector
```

**C++ 代码中导入**：
```cpp
#include "chapt4_interface/srv/face_detector.hpp"
```

---

## 八、关于 sensor_msgs/Image

`sensor_msgs/Image` 是 ROS2 官方提供的**通用图像消息**，不是人脸识别专用的。

它是一个"图片容器"，只负责装图片数据：

```
std_msgs/Header header    # 时间戳、坐标系
uint32 height             # 图片高度
uint32 width              # 图片宽度
string encoding           # 编码格式（如 rgb8, bgr8）
uint8[] data              # 像素数据
```

**与 FaceDetector.srv 的关系**：

| 东西 | 比喻 | 说明 |
|------|------|------|
| `sensor_msgs/Image` | 快递箱（官方提供） | 用来装图片数据 |
| `FaceDetector.srv` | 你写的订单（自定义） | 定义请求和响应的格式 |

人脸识别的逻辑是你自己写的，`sensor_msgs/Image` 只是帮你传输图片的工具。

---

## 九、服务的工作流程

### 9.1 服务端（Server）

1. **创建服务** - 注册服务名称，绑定自定义服务类型
2. **编写回调函数** - 当有请求来时，从请求中取出数据进行处理
3. **填充响应** - 把处理结果填入响应对象，返回给客户端

### 9.2 客户端（Client）

1. **创建客户端** - 连接到服务端的服务名称
2. **构建请求** - 把数据填入请求对象的相应字段
3. **发送请求** - 调用服务，等待响应
4. **处理响应** - 从响应对象中读取结果

### 9.3 完整流程图

```
        客户端                              服务端
          │                                   │
    ┌─────┴─────┐                      ┌──────┴──────┐
    │ 1.拿到图片  │                      │             │
    │ 2.填入请求  │ ─── Image数据 ───→  │ 3.回调触发   │
    │   对象的    │                      │   从请求对象 │
    │   image字段 │                      │   取出image │
    │            │                      │ 4.自己写的代码│
    │            │                      │   做人脸识别 │
    │ 6.从响应对象│ ←── 结果数据 ────  │ 5.把结果填入 │
    │   读取结果  │                      │   响应对象   │
    └────────────┘                      └─────────────┘
```

---

## 十、srv 文件的本质作用

**srv 文件只是定义数据结构**，它本身不做任何解析或处理。

就像一个"表格模板"，规定了请求和响应各有哪些字段。

| 谁负责 | 做什么 |
|--------|--------|
| **ROS2** | 负责网络传输、序列化/反序列化（把数据打包发送） |
| **srv 文件** | 只定义"请求长什么样、响应长什么样" |
| **你的代码** | 填充请求、处理请求、填充响应、读取响应 |

srv 就像一份"合同"，规定双方用什么格式交流。但具体怎么处理数据，这些逻辑都是你自己在代码里写的。

---

## 核心流程总结

```
1. 创建接口包（ament_cmake 类型）
         ↓
2. 创建 srv/ 文件夹，写 .srv 文件
         ↓
3. 配置 CMakeLists.txt
   - find_package(rosidl_default_generators REQUIRED)
   - rosidl_generate_interfaces(...)
         ↓
4. 配置 package.xml
   - <member_of_group>rosidl_interface_packages</member_of_group>
   - <depend>rosidl_default_generators</depend>
         ↓
5. colcon build 编译
         ↓
6. 其他包依赖它就能用了！
```

> **注意**：msg 和 action 也是同样的流程，只是文件夹和内容格式不同。
