# 04 äººè„¸æ£€æµ‹å®¢æˆ·ç«¯ - ROS2 æœåŠ¡å®¢æˆ·ç«¯å­¦ä¹ ç¬”è®°

---

## ğŸ“‘ ç›®å½•

| ç« èŠ‚ | å†…å®¹ |
|------|------|
| [ä¸€ã€å®¢æˆ·ç«¯ä¸å…¶ä»–èŠ‚ç‚¹çš„åŒºåˆ«](#ä¸€å®¢æˆ·ç«¯ä¸å…¶ä»–èŠ‚ç‚¹çš„åŒºåˆ«) | ä¸ºä»€ä¹ˆä¸éœ€è¦å›è°ƒå‡½æ•°ã€å¯¹æ¯”æ€»ç»“ |
| [äºŒã€å…³é”®ä»£ç è§£æ](#äºŒå…³é”®ä»£ç è§£æ) | wait_for_serviceã€async_send_requestã€spin_until_future_complete |
| [ä¸‰ã€å®Œæ•´ä»£ç è§£æ](#ä¸‰å®Œæ•´ä»£ç è§£æ) | å®¢æˆ·ç«¯ä»£ç å¸¦æ³¨é‡Šè®²è§£ |
| [å››ã€å®¢æˆ·ç«¯ä»£ç æ¡†æ¶æ¨¡æ¿](#å››å®¢æˆ·ç«¯ä»£ç æ¡†æ¶æ¨¡æ¿) | å¯ç›´æ¥å¤åˆ¶ä½¿ç”¨çš„æ¨¡æ¿ |
| [äº”ã€å¿«é€Ÿè®°å¿†å£è¯€](#äº”å¿«é€Ÿè®°å¿†å£è¯€) | å®¢æˆ·ç«¯äº”æ­¥èµ° |
| [å…­ã€å¸¸è§é—®é¢˜](#å…­å¸¸è§é—®é¢˜) | FAQ |
| [ä¸ƒã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é…åˆ](#ä¸ƒå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é…åˆå®Œæ•´äººè„¸æ£€æµ‹æµç¨‹) | å®Œæ•´äººè„¸æ£€æµ‹æµç¨‹ã€æ—¶åºå›¾ã€æ•°æ®æµè½¬ |
| [å…«ã€å®æˆ˜æ¡ˆä¾‹ï¼šMAVROSæ— äººæœºè§£é”](#å…«å®æˆ˜æ¡ˆä¾‹mavrosæ— äººæœºè§£é”) | å¥—ç”¨æ¡†æ¶çš„å®é™…ä¾‹å­ |
| [ä¹ã€å¦‚ä½•ç¼–å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç ](#ä¹å¦‚ä½•ç¼–å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç ) | é€šç”¨æ€è·¯ä¸æ–¹æ³• |
| [åã€C++åŸºç¡€ï¼š-> å’Œ . çš„åŒºåˆ«](#åcåŸºç¡€--å’Œ--çš„åŒºåˆ«) | æŒ‡é’ˆç”¨ç®­å¤´ï¼Œå¯¹è±¡ç”¨ç‚¹ |

---

## ä¸€ã€å®¢æˆ·ç«¯ä¸å…¶ä»–èŠ‚ç‚¹çš„åŒºåˆ«

### 1.1 ä¸ºä»€ä¹ˆå®¢æˆ·ç«¯ä¸éœ€è¦å›è°ƒå‡½æ•°ï¼Ÿ

| ç±»å‹ | è°ä¸»åŠ¨ï¼Ÿ | éœ€è¦å›è°ƒï¼Ÿ | åŸå›  |
|------|----------|------------|------|
| **Subscriber** | æ¶ˆæ¯éšæ—¶å¯èƒ½æ¥ | âœ… éœ€è¦ | ä¸çŸ¥é“æ¶ˆæ¯ä»€ä¹ˆæ—¶å€™åˆ°ï¼Œè¦"è¢«åŠ¨ç­‰å¾…" |
| **Server** | è¯·æ±‚éšæ—¶å¯èƒ½æ¥ | âœ… éœ€è¦ | ä¸çŸ¥é“å®¢æˆ·ç«¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨ï¼Œè¦"è¢«åŠ¨ç­‰å¾…" |
| **Publisher** | æˆ‘ä¸»åŠ¨å‘ | âŒ ä¸éœ€è¦ | å‘å‡ºå»å°±å®Œäº‹äº†ï¼Œä¸ç”¨ç­‰å›å¤ |
| **Client** | æˆ‘ä¸»åŠ¨é—®ï¼Œç„¶åç­‰ç­”æ¡ˆ | âŒ ä¸éœ€è¦* | æˆ‘å‘è¯·æ±‚ï¼Œæˆ‘è‡ªå·±ç­‰ç»“æœ |

**ç®€å•ç†è§£**ï¼š
- **è¢«åŠ¨æ¥æ”¶** â†’ éœ€è¦å›è°ƒï¼ˆ"æœ‰äººæ•²é—¨æˆ‘æ‰å¼€é—¨"ï¼‰
- **ä¸»åŠ¨å‘èµ·** â†’ ä¸éœ€è¦å›è°ƒï¼ˆ"æˆ‘å»æ•²åˆ«äººçš„é—¨ï¼Œç«™ç€ç­‰å¼€é—¨"ï¼‰

> *æ³¨ï¼šå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥ç”¨å›è°ƒæ–¹å¼ï¼Œä½†æœ¬ä¾‹ä½¿ç”¨çš„æ˜¯**åŒæ­¥ç­‰å¾…**æ–¹å¼ï¼Œæ›´ç®€å•ç›´è§‚

### 1.2 å¯¹æ¯”æ€»ç»“

| ç‰¹ç‚¹ | Subscriber/Server | Clientï¼ˆæœ¬ä¾‹ï¼‰ |
|------|-------------------|----------------|
| å·¥ä½œæ–¹å¼ | è¢«åŠ¨ç­‰å¾…ï¼Œæœ‰æ¶ˆæ¯å°±è§¦å‘ | ä¸»åŠ¨è¯·æ±‚ï¼ŒåŒæ­¥ç­‰å¾… |
| å›è°ƒå‡½æ•° | å¿…é¡»æœ‰ | ä¸éœ€è¦ï¼ˆåŒæ­¥æ¨¡å¼ï¼‰ |
| spinæ–¹å¼ | `rclcpp::spin(node)` æŒç»­è¿è¡Œ | `spin_until_future_complete` ç­‰åˆ°ç»“æœå°±åœ |
| ç”Ÿå‘½å‘¨æœŸ | ä¸€ç›´è¿è¡Œ | è¯·æ±‚å®Œå°±å¯ä»¥ç»“æŸ |

---

## äºŒã€å…³é”®ä»£ç è§£æ

### 2.1 ç­‰å¾…æœåŠ¡ä¸Šçº¿

```cpp
while (!client_->wait_for_service(std::chrono::seconds(1)))
{
    if(!rclcpp::ok()) {
        return false;
    }
    RCLCPP_INFO(get_logger(),"ç­‰å¾…æœåŠ¡ç«¯è¿æ¥...");
}
```

**æ‰§è¡Œæµç¨‹**ï¼š

```
wait_for_service(1ç§’)
    â”‚
    â”œâ”€â†’ æœåŠ¡ç«¯åœ¨çº¿ï¼Ÿ â”€â†’ è¿”å› true  â”€â†’ !true = false â”€â†’ é€€å‡ºwhileå¾ªç¯ âœ“
    â”‚
    â””â”€â†’ 1ç§’å†…æ²¡æ‰¾åˆ° â”€â†’ è¿”å› false â”€â†’ !false = true â”€â†’ ç»§ç»­å¾ªç¯ï¼Œå†ç­‰1ç§’
```

**æ¯”å–»**ï¼šå°±åƒåœ¨éƒ¨å®¤ç­‰æœ‹å‹
- "ç­‰1ç§’çœ‹çœ‹å¤§å®¶æ¥äº†æ²¡ï¼Ÿ"
- æ²¡æ¥ â†’ "å†ç­‰1ç§’..."
- æ¥äº† â†’ "å¤ªå¥½äº†ï¼å¯ä»¥å¼€å§‹äº†ï¼"

---

### 2.2 å‘é€è¯·æ±‚ä¸è·å–å“åº”

```cpp
// 1. åˆ›å»ºè¯·æ±‚å¯¹è±¡
auto request = std::make_shared<chapt4_interface::srv::FaceDetector::Request>();

// 2. å¡«å……è¯·æ±‚æ•°æ®ï¼ˆæŠŠå›¾ç‰‡æ”¾è¿›å»ï¼‰
request->image = ...;

// 3. å¼‚æ­¥å‘é€è¯·æ±‚ï¼Œè·å¾— future
auto future = client_->async_send_request(request);

// 4. ç­‰å¾…ç»“æœ
rclcpp::spin_until_future_complete(this->get_node_base_interface(), future);

// 5. ä» future ä¸­å–å‡ºå“åº”
auto response = future.get();
```

---

### 2.3 `async_send_request` çš„ç†è§£ï¼ˆé‡ç‚¹ï¼ï¼‰

```cpp
auto future = client_->async_send_request(request);
//   â†‘è¿”å›å€¼                              â†‘ä¼ å…¥å‚æ•°
//   Future<Response>                    Request
```

**ä¼ å…¥çš„æ˜¯ Requestï¼Œè¿”å›çš„æ˜¯ Future\<Response\>ï¼Œä¸æ˜¯ Requestï¼**

#### ç”¨åƒè›‹ç³•æ¥æ¯”å–»

```
ä½  â”€â”€â†’ ç‚¹å•ï¼ˆRequestï¼šæˆ‘è¦è‰è“è›‹ç³•ï¼‰â”€â”€â†’ è›‹ç³•åº—
                                         â”‚
                                         â”‚ åº—å‘˜åœ¨åšè›‹ç³•...
                                         â†“
ä½  â†â”€â”€ å–é¤å·ï¼ˆFutureï¼‰â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ è›‹ç³•åº—
 â”‚
 â”‚  ç­‰å¾…...
 â†“
ä½  â”€â”€â†’ ç”¨å–é¤å·æ¢è›‹ç³• â”€â”€â†’ å¾—åˆ°è›‹ç³•ï¼ˆResponseï¼‰
       future.get()
```

| æ­¥éª¤ | ä»£ç  | æ¯”å–» |
|------|------|------|
| ç‚¹å• | `request`ï¼ˆä¼ å…¥ï¼‰ | "æˆ‘è¦è‰è“è›‹ç³•" |
| æ‹¿å–é¤å· | `future`ï¼ˆè¿”å›ï¼‰ | ä¸€ä¸ªå·ç ç‰Œ |
| å–è›‹ç³• | `future.get()` | ç”¨å·ç ç‰Œæ¢çœŸæ­£çš„è›‹ç³• |

---

### 2.4 `spin_until_future_complete` çš„ä½œç”¨

```cpp
rclcpp::spin_until_future_complete(this->get_node_base_interface(), future)
```

è¿™ä¸ªå‡½æ•°åšä¸¤ä»¶äº‹ï¼š
1. **spin**ï¼šè®©èŠ‚ç‚¹"è½¬èµ·æ¥"ï¼Œå¤„ç†å„ç§äº‹ä»¶
2. **until_future_complete**ï¼šä¸€ç›´è½¬ï¼Œç›´åˆ° `future` æœ‰ç»“æœ

```
å‘é€è¯·æ±‚ â”€â”€â†’ æœåŠ¡ç«¯å¤„ç†ä¸­... â”€â”€â†’ è¿”å›ç»“æœ
   â”‚                              â”‚
   â””â”€â”€â”€â”€ spinåœ¨è¿™é‡Œç­‰å¾… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¿”å›å€¼**ï¼š
- `SUCCESS` = æˆåŠŸæ‹¿åˆ°ç»“æœ
- `TIMEOUT` = è¶…æ—¶äº†
- `INTERRUPTED` = è¢«ä¸­æ–­äº†

---

### 2.5 Request å’Œ Response çš„å…³ç³»

**å®ƒä»¬æ˜¯å®Œå…¨ä¸åŒçš„ç±»å‹ï¼**

æœåŠ¡å®šä¹‰æ–‡ä»¶ `.srv` çš„ç»“æ„ï¼š

```
# Requestï¼ˆè¯·æ±‚ï¼‰â€”â€” å®¢æˆ·ç«¯å‘ç»™æœåŠ¡ç«¯çš„
sensor_msgs/Image image
---
# Responseï¼ˆå“åº”ï¼‰â€”â€” æœåŠ¡ç«¯è¿”å›ç»™å®¢æˆ·ç«¯çš„
int32 number
float32 use_time
int32[] top
int32[] bottom
...
```

**æ•°æ®æµå‘å›¾**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æœåŠ¡ç«¯                            â”‚
â”‚  æ”¶åˆ° Request â”€â”€â†’ å¤„ç† â”€â”€â†’ ç”Ÿæˆ Response            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†‘                              â”‚
        â”‚ Request                      â”‚ Response
        â”‚ (å›¾ç‰‡æ•°æ®)                    â”‚ (äººè„¸æ•°é‡ã€ä½ç½®ç­‰)
        â”‚                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®¢æˆ·ç«¯                            â”‚
â”‚  åˆ›å»ºRequest â”€â”€â†’ å‘é€ â”€â”€â†’ ç­‰å¾… â”€â”€â†’ è·å–Response     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€å®Œæ•´ä»£ç è§£æ

```cpp
#include "chapt4_interface/srv/face_detector.hpp"  // è‡ªå®šä¹‰æœåŠ¡æ¥å£
#include "rclcpp/rclcpp.hpp"                        // ROS2 C++æ ¸å¿ƒåº“

class FaceDetectClient : public rclcpp::Node  // ç»§æ‰¿è‡ªNodeåŸºç±»
{
private:
    // å®¢æˆ·ç«¯æŒ‡é’ˆï¼Œæ¨¡æ¿å‚æ•°æ˜¯æœåŠ¡ç±»å‹
    rclcpp::Client<chapt4_interface::srv::FaceDetector>::SharedPtr client_;

public:
    // æ„é€ å‡½æ•°
    FaceDetectClient(const std::string& node_name) : Node(node_name)
    {
        // åˆ›å»ºå®¢æˆ·ç«¯ï¼Œè¿æ¥åä¸º"face_detect"çš„æœåŠ¡
        client_ = this->create_client<chapt4_interface::srv::FaceDetector>("face_detect");
        RCLCPP_INFO(get_logger(), "å®¢æˆ·ç«¯å·²åˆ›å»º");
    }

    // å‘é€è¯·æ±‚çš„å‡½æ•°
    bool send_request(/* å‚æ•° */)
    {
        // Step 1: ç­‰å¾…æœåŠ¡ä¸Šçº¿
        while (!client_->wait_for_service(std::chrono::seconds(1))) {
            if (!rclcpp::ok()) {
                return false;
            }
            RCLCPP_INFO(get_logger(), "ç­‰å¾…æœåŠ¡ç«¯è¿æ¥...");
        }

        // Step 2: åˆ›å»ºè¯·æ±‚å¯¹è±¡
        auto request = std::make_shared<chapt4_interface::srv::FaceDetector::Request>();

        // Step 3: å¡«å……è¯·æ±‚æ•°æ®
        request->image = /* ... */;

        // Step 4: å¼‚æ­¥å‘é€è¯·æ±‚
        auto future = client_->async_send_request(request);

        // Step 5: ç­‰å¾…å“åº”
        if (rclcpp::spin_until_future_complete(this->get_node_base_interface(), future)
            != rclcpp::FutureReturnCode::SUCCESS)
        {
            RCLCPP_ERROR(get_logger(), "æœåŠ¡è°ƒç”¨å¤±è´¥ï¼");
            return false;
        }

        // Step 6: è·å–å“åº”å¹¶å¤„ç†
        auto response = future.get();
        RCLCPP_INFO(get_logger(), "æ£€æµ‹åˆ°äººè„¸æ•°é‡: %d", response->number);

        return true;
    }
};

int main(int argc, char *argv[])
{
    rclcpp::init(argc, argv);                                        // â‘  åˆå§‹åŒ–ROS2
    auto node = std::make_shared<FaceDetectClient>("face_detect_client");  // â‘¡ åˆ›å»ºèŠ‚ç‚¹
    node->send_request(/* å‚æ•° */);                                  // â‘¢ å‘é€è¯·æ±‚
    rclcpp::shutdown();                                              // â‘£ å…³é—­ROS2
    return 0;
}
```

---

## å››ã€å®¢æˆ·ç«¯ä»£ç æ¡†æ¶æ¨¡æ¿

ç›´æ¥å¤åˆ¶ä½¿ç”¨ï¼Œæ›¿æ¢æ³¨é‡Šä¸­çš„å†…å®¹å³å¯ï¼š

```cpp
#include "rclcpp/rclcpp.hpp"
#include "ä½ çš„æ¥å£åŒ…/srv/ä½ çš„æœåŠ¡å.hpp"  // æ›¿æ¢ä¸ºä½ çš„æœåŠ¡æ¥å£

class MyServiceClient : public rclcpp::Node
{
private:
    // å£°æ˜å®¢æˆ·ç«¯æŒ‡é’ˆ
    rclcpp::Client<ä½ çš„æ¥å£åŒ…::srv::ä½ çš„æœåŠ¡å>::SharedPtr client_;

public:
    // æ„é€ å‡½æ•°
    MyServiceClient() : Node("my_client_node")  // æ›¿æ¢èŠ‚ç‚¹å
    {
        // åˆ›å»ºå®¢æˆ·ç«¯ï¼Œè¿æ¥æŒ‡å®šåç§°çš„æœåŠ¡
        client_ = this->create_client<ä½ çš„æ¥å£åŒ…::srv::ä½ çš„æœåŠ¡å>("æœåŠ¡åç§°");
        RCLCPP_INFO(get_logger(), "å®¢æˆ·ç«¯èŠ‚ç‚¹å·²å¯åŠ¨");
    }

    // å‘é€è¯·æ±‚å‡½æ•°
    bool send_request()
    {
        // ========== 1. ç­‰å¾…æœåŠ¡ä¸Šçº¿ ==========
        while (!client_->wait_for_service(std::chrono::seconds(1))) {
            if (!rclcpp::ok()) {
                RCLCPP_ERROR(get_logger(), "ç­‰å¾…æœåŠ¡æ—¶è¢«ä¸­æ–­");
                return false;
            }
            RCLCPP_INFO(get_logger(), "ç­‰å¾…æœåŠ¡ç«¯ä¸Šçº¿...");
        }

        // ========== 2. åˆ›å»ºå¹¶å¡«å……è¯·æ±‚ ==========
        auto request = std::make_shared<ä½ çš„æ¥å£åŒ…::srv::ä½ çš„æœåŠ¡å::Request>();
        // request->å­—æ®µå = å€¼;  // æ ¹æ®ä½ çš„.srvæ–‡ä»¶å¡«å……æ•°æ®

        // ========== 3. å‘é€è¯·æ±‚ ==========
        RCLCPP_INFO(get_logger(), "æ­£åœ¨å‘é€è¯·æ±‚...");
        auto future = client_->async_send_request(request);

        // ========== 4. ç­‰å¾…å“åº” ==========
        if (rclcpp::spin_until_future_complete(this->get_node_base_interface(), future)
            != rclcpp::FutureReturnCode::SUCCESS)
        {
            RCLCPP_ERROR(get_logger(), "æœåŠ¡è°ƒç”¨å¤±è´¥");
            return false;
        }

        // ========== 5. å¤„ç†å“åº” ==========
        auto response = future.get();
        // ä½¿ç”¨ response->å­—æ®µå è·å–è¿”å›çš„æ•°æ®
        RCLCPP_INFO(get_logger(), "æ”¶åˆ°å“åº”ï¼");

        return true;
    }
};

int main(int argc, char *argv[])
{
    rclcpp::init(argc, argv);                          // åˆå§‹åŒ–ROS2
    auto node = std::make_shared<MyServiceClient>();   // åˆ›å»ºèŠ‚ç‚¹
    node->send_request();                              // è°ƒç”¨æœåŠ¡
    rclcpp::shutdown();                                // å…³é—­ROS2
    return 0;
}
```

---

## äº”ã€å¿«é€Ÿè®°å¿†å£è¯€

```
å®¢æˆ·ç«¯äº”æ­¥èµ°ï¼š
1. ç­‰æœåŠ¡ - wait_for_service
2. å»ºè¯·æ±‚ - make_shared<Request>
3. å‘å‡ºå» - async_send_request
4. ç­‰ç»“æœ - spin_until_future_complete
5. å–å“åº” - future.get()
```

---

## å…­ã€å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆç”¨ `async_send_request` è€Œä¸æ˜¯åŒæ­¥å‘é€ï¼Ÿ
ROS2 æ¨èä½¿ç”¨å¼‚æ­¥æ–¹å¼ï¼Œé¿å…é˜»å¡æ•´ä¸ªèŠ‚ç‚¹ã€‚é…åˆ `spin_until_future_complete` å¯ä»¥å®ç°"çœ‹èµ·æ¥åŒæ­¥"çš„æ•ˆæœã€‚

### Q2: `future` æ˜¯ä»€ä¹ˆï¼Ÿ
Futureï¼ˆæœªæ¥ï¼‰æ˜¯ä¸€ä¸ª"æ‰¿è¯º"å¯¹è±¡ï¼Œè¡¨ç¤º"å°†æ¥ä¼šæœ‰ä¸€ä¸ªç»“æœ"ã€‚è°ƒç”¨ `future.get()` æ—¶ï¼Œå¦‚æœç»“æœè¿˜æ²¡å‡†å¤‡å¥½ï¼Œä¼šé˜»å¡ç­‰å¾…ã€‚

### Q3: å®¢æˆ·ç«¯å¯ä»¥ç”¨å›è°ƒå—ï¼Ÿ
å¯ä»¥ï¼`async_send_request` æœ‰é‡è½½ç‰ˆæœ¬å¯ä»¥ä¼ å…¥å›è°ƒå‡½æ•°ï¼š
```cpp
client_->async_send_request(request,
    [](rclcpp::Client<...>::SharedFuture future) {
        auto response = future.get();
        // å¤„ç†å“åº”
    });
```

---

## ä¸ƒã€å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é…åˆï¼šå®Œæ•´äººè„¸æ£€æµ‹æµç¨‹

### 7.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•´ä½“æ¶æ„                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      æœåŠ¡å: "face_detect"      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚                  â”‚                                  â”‚                  â”‚    â”‚
â”‚   â”‚   å®¢æˆ·ç«¯ Client  â”‚  â”€â”€â”€â”€ Request (å›¾ç‰‡) â”€â”€â”€â”€â”€â”€â”€â”€â†’   â”‚  æœåŠ¡ç«¯ Server   â”‚    â”‚
â”‚   â”‚                  â”‚                                  â”‚                  â”‚    â”‚
â”‚   â”‚  face_detect_    â”‚  â†â”€â”€â”€ Response (äººè„¸ä½ç½®) â”€â”€â”€â”€   â”‚  face_detect_    â”‚    â”‚
â”‚   â”‚  client.cpp      â”‚                                  â”‚  server.cpp      â”‚    â”‚
â”‚   â”‚                  â”‚                                  â”‚                  â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.2 æœåŠ¡æ¥å£å®šä¹‰ (FaceDetector.srv)

```srv
# ========== Requestï¼ˆè¯·æ±‚ï¼‰ï¼šå®¢æˆ·ç«¯ â†’ æœåŠ¡ç«¯ ==========
sensor_msgs/Image image      # è¦æ£€æµ‹çš„å›¾ç‰‡

---

# ========== Responseï¼ˆå“åº”ï¼‰ï¼šæœåŠ¡ç«¯ â†’ å®¢æˆ·ç«¯ ==========
int16 number                 # æ£€æµ‹åˆ°çš„äººè„¸æ•°é‡
float32 use_time             # å¤„ç†è€—æ—¶ï¼ˆç§’ï¼‰
int32[] top                  # æ¯å¼ äººè„¸çš„ä¸Šè¾¹ç•Œ y åæ ‡
int32[] right                # æ¯å¼ äººè„¸çš„å³è¾¹ç•Œ x åæ ‡
int32[] bottom               # æ¯å¼ äººè„¸çš„ä¸‹è¾¹ç•Œ y åæ ‡
int32[] left                 # æ¯å¼ äººè„¸çš„å·¦è¾¹ç•Œ x åæ ‡
```

---

### 7.3 é˜¶æ®µä¸€ï¼šå¯åŠ¨æœåŠ¡ç«¯ï¼ˆå…ˆå¯åŠ¨ï¼‰

```bash
ç»ˆç«¯1: ros2 run demo_cpp_service face_detect_server
```

**æœåŠ¡ç«¯åšäº†ä»€ä¹ˆ**ï¼š

| æ­¥éª¤ | ä»£ç ä½ç½® | å…·ä½“åŠ¨ä½œ |
|------|----------|----------|
| â‘  | mainç¬¬62è¡Œ | `rclcpp::init()` åˆå§‹åŒ– ROS2 |
| â‘¡ | mainç¬¬63è¡Œ | åˆ›å»º `FaceDetectServer` èŠ‚ç‚¹ |
| â‘¢ | æ„é€ å‡½æ•°ç¬¬16-21è¡Œ | åˆ›å»ºæœåŠ¡ï¼Œåç§°ä¸º `"face_detect"`ï¼Œç»‘å®šå›è°ƒå‡½æ•° |
| â‘£ | æ„é€ å‡½æ•°ç¬¬23-26è¡Œ | åŠ è½½ OpenCV äººè„¸æ£€æµ‹æ¨¡å‹ (Haarçº§è”åˆ†ç±»å™¨) |
| â‘¤ | mainç¬¬64è¡Œ | `rclcpp::spin(node)` å¼€å§‹**æ— é™å¾ªç¯ç­‰å¾…**è¯·æ±‚ |

```cpp
// æœåŠ¡ç«¯æ„é€ å‡½æ•°å…³é”®ä»£ç 
service_ = this->create_service<chapt4_interface::srv::FaceDetector>(
    "face_detect",                           // æœåŠ¡åç§°
    std::bind(&FaceDetectServer::detect_callback, this, _1, _2)  // å›è°ƒå‡½æ•°
);

// åŠ è½½äººè„¸æ£€æµ‹æ¨¡å‹
face_cascade_.load("/usr/share/opencv4/haarcascades/haarcascade_frontalface_default.xml");
```

**æ­¤æ—¶æœåŠ¡ç«¯çŠ¶æ€**ï¼šğŸŸ¢ è¿è¡Œä¸­ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚...

---

### 7.4 é˜¶æ®µäºŒï¼šå¯åŠ¨å®¢æˆ·ç«¯

```bash
ç»ˆç«¯2: ros2 run demo_cpp_service face_detect_client
```

**å®¢æˆ·ç«¯åšäº†ä»€ä¹ˆ**ï¼š

| æ­¥éª¤ | ä»£ç ä½ç½® | å…·ä½“åŠ¨ä½œ |
|------|----------|----------|
| â‘  | mainç¬¬85è¡Œ | `rclcpp::init()` åˆå§‹åŒ– ROS2 |
| â‘¡ | mainç¬¬86è¡Œ | åˆ›å»º `FaceDetectClient` èŠ‚ç‚¹ |
| â‘¢ | æ„é€ å‡½æ•°ç¬¬20è¡Œ | åˆ›å»ºå®¢æˆ·ç«¯ï¼Œè¿æ¥æœåŠ¡å `"face_detect"` |
| â‘£ | mainç¬¬88-89è¡Œ | è·å–å›¾ç‰‡è·¯å¾„ï¼ˆé»˜è®¤ `resource/zidane.jpg`ï¼‰|
| â‘¤ | mainç¬¬96è¡Œ | è°ƒç”¨ `send_request()` å‘é€æ£€æµ‹è¯·æ±‚ |

---

### 7.5 é˜¶æ®µä¸‰ï¼šå®¢æˆ·ç«¯å‘é€è¯·æ±‚

**å®¢æˆ·ç«¯ `send_request()` å‡½æ•°è¯¦ç»†æµç¨‹**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å®¢æˆ·ç«¯ send_request()                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: ç­‰å¾…æœåŠ¡ä¸Šçº¿ (ç¬¬26-34è¡Œ)                          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   while (!client_->wait_for_service(1ç§’)) {             â”‚   â”‚
â”‚  â”‚       æ‰“å° "ç­‰å¾…æœåŠ¡ç«¯è¿æ¥..."                            â”‚   â”‚
â”‚  â”‚   }                                                     â”‚   â”‚
â”‚  â”‚   // æ‰¾åˆ°æœåŠ¡ç«¯äº†ï¼ç»§ç»­æ‰§è¡Œ                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: è¯»å–å›¾ç‰‡ (ç¬¬36-42è¡Œ)                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   cv::Mat image = cv::imread(image_path);               â”‚   â”‚
â”‚  â”‚   // ç”¨OpenCVè¯»å–æœ¬åœ°å›¾ç‰‡æ–‡ä»¶                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: åˆ›å»ºè¯·æ±‚å¹¶å¡«å……æ•°æ® (ç¬¬44-46è¡Œ)                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   auto request = make_shared<Request>();                â”‚   â”‚
â”‚  â”‚   request->image = cv_bridgeè½¬æ¢(image);                â”‚   â”‚
â”‚  â”‚   // æŠŠOpenCVå›¾ç‰‡è½¬æˆROS2æ¶ˆæ¯æ ¼å¼                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: å‘é€è¯·æ±‚ (ç¬¬49è¡Œ)                                 â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   auto future = client_->async_send_request(request);   â”‚   â”‚
â”‚  â”‚   // æŠŠå›¾ç‰‡å‘ç»™æœåŠ¡ç«¯ï¼Œæ‹¿åˆ°ä¸€ä¸ª"å–é¤å·"                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚               ï¼ˆè¯·æ±‚å·²å‘å‡ºï¼Œç­‰å¾…æœåŠ¡ç«¯å¤„ç†...ï¼‰                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.6 é˜¶æ®µå››ï¼šæœåŠ¡ç«¯å¤„ç†è¯·æ±‚ï¼ˆæ ¸å¿ƒï¼ï¼‰

**æœåŠ¡ç«¯æ”¶åˆ°è¯·æ±‚åï¼Œ`detect_callback()` è¢«è‡ªåŠ¨è°ƒç”¨**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              æœåŠ¡ç«¯ detect_callback() å›è°ƒå‡½æ•°                    â”‚
â”‚              (ç¬¬31-57è¡Œ)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  è¾“å…¥: request (åŒ…å«å›¾ç‰‡)                                        â”‚
â”‚  è¾“å‡º: response (äººè„¸ä½ç½®ä¿¡æ¯)                                    â”‚
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 1: è®°å½•å¼€å§‹æ—¶é—´ (ç¬¬34è¡Œ)                             â”‚   â”‚
â”‚  â”‚   auto start_time = this->now();                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 2: æå–å›¾ç‰‡ (ç¬¬35è¡Œ)                                 â”‚   â”‚
â”‚  â”‚   cv::Mat image = cv_bridge::toCvCopy(request->image)   â”‚   â”‚
â”‚  â”‚   // æŠŠROS2æ¶ˆæ¯æ ¼å¼è½¬å›OpenCVæ ¼å¼                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 3: è½¬ç°åº¦å›¾ (ç¬¬37-38è¡Œ)                              â”‚   â”‚
â”‚  â”‚   cv::cvtColor(image, gray, COLOR_BGR2GRAY);            â”‚   â”‚
â”‚  â”‚   // äººè„¸æ£€æµ‹éœ€è¦ç°åº¦å›¾ï¼Œæé«˜å¤„ç†é€Ÿåº¦                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 4: äººè„¸æ£€æµ‹ (ç¬¬40-41è¡Œ) â­æ ¸å¿ƒâ­                      â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   std::vector<cv::Rect> faces;                          â”‚   â”‚
â”‚  â”‚   face_cascade_.detectMultiScale(                       â”‚   â”‚
â”‚  â”‚       gray,          // è¾“å…¥ï¼šç°åº¦å›¾                      â”‚   â”‚
â”‚  â”‚       faces,         // è¾“å‡ºï¼šæ£€æµ‹åˆ°çš„äººè„¸çŸ©å½¢æ¡†            â”‚   â”‚
â”‚  â”‚       1.1,           // ç¼©æ”¾å› å­                         â”‚   â”‚
â”‚  â”‚       15,            // æœ€å°é‚»å±…æ•°                        â”‚   â”‚
â”‚  â”‚       0,             // æ ‡å¿—ä½                           â”‚   â”‚
â”‚  â”‚       cv::Size(80,80) // æœ€å°äººè„¸å°ºå¯¸                     â”‚   â”‚
â”‚  â”‚   );                                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 5: å¡«å……å“åº”æ•°æ® (ç¬¬43-51è¡Œ)                          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   response->number = faces.size();  // äººè„¸æ•°é‡          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   for (æ¯ä¸ªæ£€æµ‹åˆ°çš„äººè„¸ face) {                           â”‚   â”‚
â”‚  â”‚       response->top.push_back(face.y);          // ä¸Š    â”‚   â”‚
â”‚  â”‚       response->bottom.push_back(face.y+height); // ä¸‹   â”‚   â”‚
â”‚  â”‚       response->left.push_back(face.x);          // å·¦   â”‚   â”‚
â”‚  â”‚       response->right.push_back(face.x+width);   // å³   â”‚   â”‚
â”‚  â”‚   }                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 6: è®¡ç®—è€—æ—¶ (ç¬¬53-54è¡Œ)                              â”‚   â”‚
â”‚  â”‚   response->use_time = (end_time - start_time).seconds()â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚            å‡½æ•°è¿”å›ï¼Œresponse è‡ªåŠ¨å‘å›å®¢æˆ·ç«¯                       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.7 é˜¶æ®µäº”ï¼šå®¢æˆ·ç«¯æ¥æ”¶å“åº”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                å®¢æˆ·ç«¯ç»§ç»­ send_request()                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 5: ç­‰å¾…å“åº”å®Œæˆ (ç¬¬51-55è¡Œ)                          â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   spin_until_future_complete(..., future);              â”‚   â”‚
â”‚  â”‚   // ä¸€ç›´ç­‰ï¼Œç›´åˆ°æœåŠ¡ç«¯è¿”å›ç»“æœ                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 6: è·å–å“åº” (ç¬¬57è¡Œ)                                 â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   auto response = future.get();                         â”‚   â”‚
â”‚  â”‚   // ä»futureä¸­å–å‡ºæœåŠ¡ç«¯è¿”å›çš„æ•°æ®                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â†“                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Step 7: æ˜¾ç¤ºç»“æœ (ç¬¬58-74è¡Œ)                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   æ‰“å°: "æ£€æµ‹åˆ°äººè„¸æ•°é‡: X"                               â”‚   â”‚
â”‚  â”‚   æ‰“å°: "å¤„ç†è€—æ—¶: X.XXX ç§’"                              â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   for (æ¯ä¸ªäººè„¸) {                                       â”‚   â”‚
â”‚  â”‚       åœ¨å›¾ç‰‡ä¸Šç”»çŸ©å½¢æ¡† (ç»¿è‰²)                              â”‚   â”‚
â”‚  â”‚       æ‰“å°äººè„¸åæ ‡                                        â”‚   â”‚
â”‚  â”‚   }                                                     â”‚   â”‚
â”‚  â”‚                                                         â”‚   â”‚
â”‚  â”‚   cv::imshow() æ˜¾ç¤ºæ ‡æ³¨åçš„å›¾ç‰‡                           â”‚   â”‚
â”‚  â”‚   cv::waitKey(0) ç­‰å¾…æŒ‰é”®å…³é—­                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.8 å®Œæ•´æ—¶åºå›¾

```
     å®¢æˆ·ç«¯ (Client)                              æœåŠ¡ç«¯ (Server)
          â”‚                                            â”‚
          â”‚  â† â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€ â”€    â”‚
          â”‚         æœåŠ¡ç«¯å…ˆå¯åŠ¨ï¼Œç­‰å¾…è¯·æ±‚...             â”‚
          â”‚                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ å¯åŠ¨å®¢æˆ·ç«¯ â”‚                               â”‚  spin()   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                               â”‚  ç­‰å¾…ä¸­... â”‚
          â”‚                                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                      â”‚
    â”‚ ç­‰å¾…æœåŠ¡   â”‚ â”€â”€â”€ æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨çº¿? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â†â”€â”€ åœ¨çº¿ï¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
          â”‚                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                      â”‚
    â”‚ è¯»å–å›¾ç‰‡   â”‚                                      â”‚
    â”‚ zidane.jpg â”‚                                     â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                      â”‚
          â”‚                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                                      â”‚
    â”‚ åˆ›å»ºRequestâ”‚                                      â”‚
    â”‚ å¡«å…¥å›¾ç‰‡   â”‚                                      â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                                      â”‚
          â”‚                                            â”‚
          â”‚ â•â•â•â•â•â•â•â• Request (å›¾ç‰‡æ•°æ®) â•â•â•â•â•â•â•â•â•â•â•â†’   â”‚
          â”‚                                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚ æ”¶åˆ°è¯·æ±‚ï¼ â”‚
          â”‚                                     â”‚ è§¦å‘å›è°ƒ   â”‚
          â”‚                                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                            â”‚
          â”‚                                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚ è½¬ç°åº¦å›¾   â”‚
          â”‚                                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                            â”‚
          â”‚                                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚ äººè„¸æ£€æµ‹   â”‚
          â”‚                                     â”‚ detectMultiScale
          â”‚                                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                            â”‚
          â”‚                                     â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
          â”‚                                     â”‚ å¡«å……Responseâ”‚
          â”‚                                     â”‚ äººè„¸æ•°é‡    â”‚
          â”‚                                     â”‚ åæ ‡ä¿¡æ¯    â”‚
          â”‚                                     â”‚ è€—æ—¶        â”‚
          â”‚                                     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                                            â”‚
          â”‚ â†â•â•â•â•â•â•â• Response (æ£€æµ‹ç»“æœ) â•â•â•â•â•â•â•â•â•â•â•   â”‚
          â”‚                                            â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”                               â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ æ”¶åˆ°å“åº”ï¼ â”‚                               â”‚  ç»§ç»­ç­‰å¾…  â”‚
    â”‚ future.get()                              â”‚  ä¸‹ä¸€ä¸ªè¯·æ±‚ â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ ç”»çŸ©å½¢æ¡†   â”‚
    â”‚ æ˜¾ç¤ºå›¾ç‰‡   â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚ ç¨‹åºç»“æŸ   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 7.9 æ•°æ®æµè½¬æ€»ç»“

| é˜¶æ®µ | è° | åšä»€ä¹ˆ | æ•°æ® |
|------|-----|--------|------|
| 1 | å®¢æˆ·ç«¯ | è¯»å–æœ¬åœ°å›¾ç‰‡ | `cv::Mat image` |
| 2 | å®¢æˆ·ç«¯ | è½¬æ¢æ ¼å¼ | OpenCV â†’ ROS2 Image |
| 3 | å®¢æˆ·ç«¯ | å‘é€è¯·æ±‚ | `request->image` |
| 4 | æœåŠ¡ç«¯ | æ¥æ”¶å¹¶è½¬æ¢ | ROS2 Image â†’ OpenCV |
| 5 | æœåŠ¡ç«¯ | è½¬ç°åº¦å›¾ | BGR â†’ Gray |
| 6 | æœåŠ¡ç«¯ | **äººè„¸æ£€æµ‹** | `detectMultiScale()` |
| 7 | æœåŠ¡ç«¯ | å¡«å……å“åº” | äººè„¸åæ ‡ â†’ `response` |
| 8 | å®¢æˆ·ç«¯ | æ¥æ”¶å“åº” | `future.get()` |
| 9 | å®¢æˆ·ç«¯ | ç”»æ¡†æ˜¾ç¤º | `cv::rectangle()` |

---

### 7.10 æœåŠ¡ç«¯å®Œæ•´ä»£ç ï¼ˆå¸¦æ³¨é‡Šï¼‰

```cpp
#include "chapt4_interface/srv/face_detector.hpp"
#include "cv_bridge/cv_bridge.h"
#include "opencv2/opencv.hpp"
#include "rclcpp/rclcpp.hpp"

class FaceDetectServer : public rclcpp::Node
{
private:
    // æœåŠ¡ç«¯æŒ‡é’ˆ
    rclcpp::Service<chapt4_interface::srv::FaceDetector>::SharedPtr service_;
    // OpenCVäººè„¸æ£€æµ‹å™¨
    cv::CascadeClassifier face_cascade_;

public:
    explicit FaceDetectServer(const std::string &node_name) : Node(node_name)
    {
        // åˆ›å»ºæœåŠ¡ï¼Œç»‘å®šå›è°ƒå‡½æ•°
        service_ = this->create_service<chapt4_interface::srv::FaceDetector>(
            "face_detect",
            std::bind(&FaceDetectServer::detect_callback, this,
                      std::placeholders::_1, std::placeholders::_2));

        // åŠ è½½äººè„¸æ£€æµ‹æ¨¡å‹
        face_cascade_.load("/usr/share/opencv4/haarcascades/haarcascade_frontalface_default.xml");

        RCLCPP_INFO(get_logger(), "äººè„¸æ£€æµ‹æœåŠ¡å·²å¯åŠ¨ï¼Œç­‰å¾…è¯·æ±‚...");
    }

    // å›è°ƒå‡½æ•°ï¼šæ”¶åˆ°è¯·æ±‚æ—¶è‡ªåŠ¨è°ƒç”¨
    void detect_callback(
        const chapt4_interface::srv::FaceDetector::Request::SharedPtr request,
        chapt4_interface::srv::FaceDetector::Response::SharedPtr response)
    {
        // è®°å½•å¼€å§‹æ—¶é—´
        auto start_time = this->now();

        // å°†ROS2å›¾ç‰‡æ¶ˆæ¯è½¬æ¢ä¸ºOpenCVæ ¼å¼
        cv::Mat image = cv_bridge::toCvCopy(request->image, "bgr8")->image;

        // è½¬ç°åº¦å›¾ï¼ˆäººè„¸æ£€æµ‹éœ€è¦ï¼‰
        cv::Mat gray;
        cv::cvtColor(image, gray, cv::COLOR_BGR2GRAY);

        // æ‰§è¡Œäººè„¸æ£€æµ‹
        std::vector<cv::Rect> faces;
        face_cascade_.detectMultiScale(gray, faces, 1.1, 15, 0, cv::Size(80, 80));

        // å¡«å……å“åº”æ•°æ®
        response->number = faces.size();
        for (const auto &face : faces)
        {
            response->top.push_back(face.y);
            response->bottom.push_back(face.y + face.height);
            response->left.push_back(face.x);
            response->right.push_back(face.x + face.width);
        }

        // è®¡ç®—è€—æ—¶
        auto end_time = this->now();
        response->use_time = (end_time - start_time).seconds();

        RCLCPP_INFO(get_logger(), "æ£€æµ‹åˆ°%då¼ äººè„¸,è€—æ—¶%.3fç§’",
                    response->number, response->use_time);
    }
};

int main(int argc, char *argv[])
{
    rclcpp::init(argc, argv);
    auto node = std::make_shared<FaceDetectServer>("face_detect_server");
    rclcpp::spin(node);  // æŒç»­è¿è¡Œï¼Œç­‰å¾…è¯·æ±‚
    rclcpp::shutdown();
    return 0;
}
```

---

## å…«ã€å®æˆ˜æ¡ˆä¾‹ï¼šMAVROSæ— äººæœºè§£é”

### 8.1 åœºæ™¯åˆ†æ

```
ä½ çš„ä»£ç ï¼ˆå®¢æˆ·ç«¯ï¼‰â”€â”€â†’ è°ƒç”¨armingæœåŠ¡ â”€â”€â†’ MAVROSï¼ˆæœåŠ¡ç«¯ï¼‰â”€â”€â†’ PX4é£æ§
```

**è§£é”æ— äººæœº = è°ƒç”¨MAVROSæä¾›çš„æœåŠ¡**ï¼Œå’Œäººè„¸æ£€æµ‹çš„åŸç†ä¸€æ¨¡ä¸€æ ·ï¼

---

### 8.2 ç¡®å®šè¦è°ƒç”¨çš„æœåŠ¡

| åŠŸèƒ½ | æœåŠ¡å | æœåŠ¡ç±»å‹ |
|------|--------|----------|
| è§£é”/ä¸Šé” | `/mavros/cmd/arming` | `mavros_msgs/srv/CommandBool` |
| è®¾ç½®æ¨¡å¼ | `/mavros/set_mode` | `mavros_msgs/srv/SetMode` |

**æŸ¥çœ‹æœåŠ¡æ¥å£**ï¼š
```bash
ros2 interface show mavros_msgs/srv/CommandBool
```

```srv
# CommandBool.srv
bool value    # true=è§£é”, false=ä¸Šé”
---
bool success  # æ˜¯å¦æˆåŠŸ
uint8 result  # ç»“æœç 
```

---

### 8.3 å¥—ç”¨å®¢æˆ·ç«¯æ¡†æ¶

å¯¹ç…§"äº”æ­¥èµ°"ï¼Œåªéœ€è¦æ›¿æ¢ä¸‰ä¸ªåœ°æ–¹ï¼š

| æ›¿æ¢é¡¹ | äººè„¸æ£€æµ‹ | æ— äººæœºè§£é” |
|--------|----------|------------|
| æœåŠ¡ç±»å‹ | `chapt4_interface::srv::FaceDetector` | `mavros_msgs::srv::CommandBool` |
| æœåŠ¡åç§° | `"face_detect"` | `"/mavros/cmd/arming"` |
| Requestå­—æ®µ | `request->image = ...` | `request->value = true` |

---

### 8.4 å®Œæ•´ä»£ç 

```cpp
#include "rclcpp/rclcpp.hpp"
#include "mavros_msgs/srv/command_bool.hpp"

class ArmingClient : public rclcpp::Node
{
private:
    rclcpp::Client<mavros_msgs::srv::CommandBool>::SharedPtr arming_client_;

public:
    ArmingClient() : Node("arming_client")
    {
        // åˆ›å»ºå®¢æˆ·ç«¯ï¼Œè¿æ¥MAVROSçš„armingæœåŠ¡
        arming_client_ = this->create_client<mavros_msgs::srv::CommandBool>(
            "/mavros/cmd/arming");
        RCLCPP_INFO(get_logger(), "è§£é”å®¢æˆ·ç«¯å·²åˆ›å»º");
    }

    bool arm()
    {
        // ========== äº”æ­¥èµ° ==========

        // 1. ç­‰æœåŠ¡
        while (!arming_client_->wait_for_service(std::chrono::seconds(1))) {
            if (!rclcpp::ok()) return false;
            RCLCPP_INFO(get_logger(), "ç­‰å¾…armingæœåŠ¡...");
        }

        // 2. å»ºè¯·æ±‚
        auto request = std::make_shared<mavros_msgs::srv::CommandBool::Request>();
        request->value = true;  // true=è§£é”, false=ä¸Šé”

        // 3. å‘å‡ºå»
        RCLCPP_INFO(get_logger(), "å‘é€è§£é”è¯·æ±‚...");
        auto future = arming_client_->async_send_request(request);

        // 4. ç­‰ç»“æœ
        if (rclcpp::spin_until_future_complete(get_node_base_interface(), future)
            != rclcpp::FutureReturnCode::SUCCESS)
        {
            RCLCPP_ERROR(get_logger(), "æœåŠ¡è°ƒç”¨å¤±è´¥");
            return false;
        }

        // 5. å–å“åº”
        auto response = future.get();
        if (response->success) {
            RCLCPP_INFO(get_logger(), "æ— äººæœºè§£é”æˆåŠŸï¼");
        } else {
            RCLCPP_ERROR(get_logger(), "è§£é”å¤±è´¥ï¼Œresult=%d", response->result);
        }
        return response->success;
    }
};

int main(int argc, char *argv[])
{
    rclcpp::init(argc, argv);
    auto node = std::make_shared<ArmingClient>();
    node->arm();
    rclcpp::shutdown();
    return 0;
}
```

---

### 8.5 å¯¹æ¯”ï¼šä»£ç ç»“æ„å®Œå…¨ä¸€è‡´

```
äººè„¸æ£€æµ‹å®¢æˆ·ç«¯                         æ— äººæœºè§£é”å®¢æˆ·ç«¯
      â”‚                                     â”‚
      â”œâ”€ create_client<FaceDetector>        â”œâ”€ create_client<CommandBool>
      â”‚     ("face_detect")                 â”‚     ("/mavros/cmd/arming")
      â”‚                                     â”‚
      â”œâ”€ request->image = å›¾ç‰‡              â”œâ”€ request->value = true
      â”‚                                     â”‚
      â”œâ”€ async_send_request(request)        â”œâ”€ async_send_request(request)
      â”‚                                     â”‚
      â”œâ”€ spin_until_future_complete         â”œâ”€ spin_until_future_complete
      â”‚                                     â”‚
      â””â”€ response->number                   â””â”€ response->success
```

**ç»“è®º**ï¼šæŒæ¡ä¸€ä¸ªï¼Œå°±èƒ½å†™æ‰€æœ‰å®¢æˆ·ç«¯ï¼

---

## ä¹ã€å¦‚ä½•ç¼–å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç 

### 9.1 é€šç”¨æ€è·¯æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç¼–å†™æœåŠ¡é€šä¿¡ä»£ç çš„æ€è·¯                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Step 1: æ˜ç¡®éœ€æ±‚              â”‚
              â”‚  "è°è¯·æ±‚è°ï¼Ÿä¼ ä»€ä¹ˆæ•°æ®ï¼Ÿè¿”å›ä»€ä¹ˆï¼Ÿ"â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Step 2: å®šä¹‰æœåŠ¡æ¥å£ (.srv)   â”‚
              â”‚  Request: éœ€è¦ä¼ å…¥çš„æ•°æ®        â”‚
              â”‚  Response: éœ€è¦è¿”å›çš„æ•°æ®       â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Step 3: ç¼–å†™æœåŠ¡ç«¯             â”‚
              â”‚  - åˆ›å»ºæœåŠ¡ï¼Œç»‘å®šå›è°ƒ           â”‚
              â”‚  - å›è°ƒä¸­å¤„ç†è¯·æ±‚ï¼Œå¡«å……å“åº”      â”‚
              â”‚  - spin() æŒç»­è¿è¡Œ             â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Step 4: ç¼–å†™å®¢æˆ·ç«¯            â”‚
              â”‚  - äº”æ­¥èµ°ï¼šç­‰ã€å»ºã€å‘ã€ç­‰ã€å–    â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Step 5: æµ‹è¯•                  â”‚
              â”‚  - å…ˆå¯åŠ¨æœåŠ¡ç«¯                 â”‚
              â”‚  - å†å¯åŠ¨å®¢æˆ·ç«¯                 â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 9.2 è¯¦ç»†æ­¥éª¤

#### Step 1: æ˜ç¡®éœ€æ±‚

é—®è‡ªå·±ä¸‰ä¸ªé—®é¢˜ï¼š

| é—®é¢˜ | ç¤ºä¾‹ï¼ˆäººè„¸æ£€æµ‹ï¼‰ | ç¤ºä¾‹ï¼ˆæ— äººæœºè§£é”ï¼‰ |
|------|------------------|-------------------|
| å®¢æˆ·ç«¯è¦å‘ä»€ä¹ˆï¼Ÿ | ä¸€å¼ å›¾ç‰‡ | è§£é”æŒ‡ä»¤(true/false) |
| æœåŠ¡ç«¯è¦åšä»€ä¹ˆï¼Ÿ | æ£€æµ‹äººè„¸ | å‘é€MAVLinkå‘½ä»¤ |
| æœåŠ¡ç«¯è¦è¿”å›ä»€ä¹ˆï¼Ÿ | äººè„¸æ•°é‡å’Œä½ç½® | æ˜¯å¦æˆåŠŸ |

---

#### Step 2: å®šä¹‰æœåŠ¡æ¥å£ (.srvæ–‡ä»¶)

```srv
# æ–‡ä»¶: ä½ çš„æ¥å£åŒ…/srv/ä½ çš„æœåŠ¡å.srv

# ===== Requestï¼ˆå®¢æˆ·ç«¯å‘ç»™æœåŠ¡ç«¯ï¼‰=====
æ•°æ®ç±»å‹ å­—æ®µå
æ•°æ®ç±»å‹ å­—æ®µå
---
# ===== Responseï¼ˆæœåŠ¡ç«¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼‰=====
æ•°æ®ç±»å‹ å­—æ®µå
æ•°æ®ç±»å‹ å­—æ®µå
```

**ç¤ºä¾‹ï¼šåŠ æ³•æœåŠ¡**
```srv
# AddTwoInts.srv
int64 a
int64 b
---
int64 sum
```

---

#### Step 3: ç¼–å†™æœåŠ¡ç«¯

```cpp
// æœåŠ¡ç«¯æ¡†æ¶
class MyServer : public rclcpp::Node
{
private:
    rclcpp::Service<æ¥å£ç±»å‹>::SharedPtr service_;

public:
    MyServer() : Node("server_node")
    {
        // åˆ›å»ºæœåŠ¡ï¼Œç»‘å®šå›è°ƒ
        service_ = this->create_service<æ¥å£ç±»å‹>(
            "æœåŠ¡åç§°",
            std::bind(&MyServer::callback, this, _1, _2));
    }

    // å›è°ƒå‡½æ•°ï¼šæ”¶åˆ°è¯·æ±‚æ—¶è‡ªåŠ¨æ‰§è¡Œ
    void callback(const æ¥å£ç±»å‹::Request::SharedPtr request,
                  æ¥å£ç±»å‹::Response::SharedPtr response)
    {
        // 1. ä» request å–å‡ºæ•°æ®
        // 2. å¤„ç†ä¸šåŠ¡é€»è¾‘
        // 3. æŠŠç»“æœå¡«å…¥ response
    }
};

int main(...)
{
    rclcpp::init(...);
    auto node = std::make_shared<MyServer>();
    rclcpp::spin(node);  // æŒç»­è¿è¡Œï¼
    rclcpp::shutdown();
}
```

---

#### Step 4: ç¼–å†™å®¢æˆ·ç«¯ï¼ˆäº”æ­¥èµ°ï¼‰

```cpp
// å®¢æˆ·ç«¯æ¡†æ¶
class MyClient : public rclcpp::Node
{
private:
    rclcpp::Client<æ¥å£ç±»å‹>::SharedPtr client_;

public:
    MyClient() : Node("client_node")
    {
        client_ = this->create_client<æ¥å£ç±»å‹>("æœåŠ¡åç§°");
    }

    void call_service()
    {
        // 1. ç­‰æœåŠ¡
        while (!client_->wait_for_service(1s)) { ... }

        // 2. å»ºè¯·æ±‚
        auto request = std::make_shared<æ¥å£ç±»å‹::Request>();
        request->å­—æ®µ = å€¼;

        // 3. å‘å‡ºå»
        auto future = client_->async_send_request(request);

        // 4. ç­‰ç»“æœ
        spin_until_future_complete(..., future);

        // 5. å–å“åº”
        auto response = future.get();
        // ä½¿ç”¨ response->å­—æ®µ
    }
};
```

---

#### Step 5: æµ‹è¯•

```bash
# ç»ˆç«¯1ï¼šå¯åŠ¨æœåŠ¡ç«¯ï¼ˆå…ˆå¯åŠ¨ï¼ï¼‰
ros2 run ä½ çš„åŒ…å æœåŠ¡ç«¯èŠ‚ç‚¹å

# ç»ˆç«¯2ï¼šå¯åŠ¨å®¢æˆ·ç«¯
ros2 run ä½ çš„åŒ…å å®¢æˆ·ç«¯èŠ‚ç‚¹å
```

---

### 9.3 å¿«é€Ÿæ£€æŸ¥æ¸…å•

ç¼–å†™å®Œæˆåï¼Œå¯¹ç…§æ£€æŸ¥ï¼š

**æœåŠ¡ç«¯æ£€æŸ¥**ï¼š
- [ ] ç»§æ‰¿äº† `rclcpp::Node`ï¼Ÿ
- [ ] `create_service` çš„æœåŠ¡åå’Œå®¢æˆ·ç«¯ä¸€è‡´ï¼Ÿ
- [ ] å›è°ƒå‡½æ•°å‚æ•°ç±»å‹æ­£ç¡®ï¼Ÿï¼ˆRequest::SharedPtr, Response::SharedPtrï¼‰
- [ ] mainå‡½æ•°é‡Œç”¨çš„æ˜¯ `spin(node)` æŒç»­è¿è¡Œï¼Ÿ

**å®¢æˆ·ç«¯æ£€æŸ¥**ï¼š
- [ ] ç»§æ‰¿äº† `rclcpp::Node`ï¼Ÿ
- [ ] `create_client` çš„æœåŠ¡åå’ŒæœåŠ¡ç«¯ä¸€è‡´ï¼Ÿ
- [ ] æœ‰ `wait_for_service` ç­‰å¾…æœåŠ¡ä¸Šçº¿ï¼Ÿ
- [ ] `async_send_request` åæœ‰ç­‰å¾…ç»“æœï¼Ÿ
- [ ] ç”¨ `future.get()` å–å‡ºå“åº”ï¼Ÿ

---

### 9.4 å¸¸è§é”™è¯¯æ’æŸ¥

| ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ³• |
|------|----------|----------|
| å®¢æˆ·ç«¯ä¸€ç›´æ˜¾ç¤º"ç­‰å¾…æœåŠ¡..." | æœåŠ¡ç«¯æ²¡å¯åŠ¨ / æœåŠ¡åä¸ä¸€è‡´ | æ£€æŸ¥æœåŠ¡åæ‹¼å†™ |
| ç¼–è¯‘æŠ¥é”™æ‰¾ä¸åˆ°æ¥å£ | æ²¡æœ‰æ·»åŠ ä¾èµ– | CMakeLists.txt å’Œ package.xml æ·»åŠ æ¥å£åŒ… |
| æœåŠ¡è°ƒç”¨å¤±è´¥ | æœåŠ¡ç«¯å›è°ƒæŠ¥é”™ | æ£€æŸ¥æœåŠ¡ç«¯æ—¥å¿— |
| Response æ•°æ®ä¸ºç©º | æœåŠ¡ç«¯æ²¡å¡«å…… response | æ£€æŸ¥å›è°ƒå‡½æ•°æ˜¯å¦æ­£ç¡®å¡«å…… |

---

## åã€C++åŸºç¡€ï¼š-> å’Œ . çš„åŒºåˆ«

### 10.1 ä¸€å¥è¯è®°ä½

| ç¬¦å· | ç”¨äº | å£è¯€ |
|------|------|------|
| `.` | æ™®é€šå¯¹è±¡ | "**å®ä½“ç”¨ç‚¹**" |
| `->` | æŒ‡é’ˆ | "**æŒ‡é’ˆç”¨ç®­å¤´**" |

---

### 10.2 æ€ä¹ˆåˆ¤æ–­ï¼Ÿçœ‹å£°æ˜ï¼

```cpp
// æƒ…å†µ1ï¼šæ™®é€šå¯¹è±¡ â†’ ç”¨ .
std::string name;
name.size();        // ç”¨ .

cv::Mat image;
image.empty();      // ç”¨ .

// æƒ…å†µ2ï¼šæŒ‡é’ˆ â†’ ç”¨ ->
std::string* name_ptr;
name_ptr->size();   // ç”¨ ->

cv::Mat* image_ptr;
image_ptr->empty(); // ç”¨ ->
```

---

### 10.3 å¿«é€Ÿåˆ¤æ–­è¡¨

| çœ‹åˆ°è¿™ç§å£°æ˜ | ç”¨ä»€ä¹ˆ | ä¾‹å­ |
|-------------|--------|------|
| `Type å˜é‡å` | `.` | `cv::Mat image;` â†’ `image.empty()` |
| `Type* å˜é‡å` | `->` | `cv::Mat* ptr;` â†’ `ptr->empty()` |
| `Type::SharedPtr å˜é‡å` | `->` | `Client::SharedPtr client_;` â†’ `client_->xxx()` |
| `std::shared_ptr<Type>` | `->` | `auto ptr = std::make_shared<X>();` â†’ `ptr->xxx()` |
| `auto å˜é‡å = make_shared<>()` | `->` | `auto request = make_shared<Request>();` â†’ `request->xxx` |

**å…³é”®è¯**ï¼šçœ‹åˆ° `SharedPtr`ã€`shared_ptr`ã€`make_shared`ã€`*` â†’ éƒ½æ˜¯æŒ‡é’ˆ â†’ ç”¨ `->`

---

### 10.4 åœ¨ROS2ä»£ç ä¸­çš„åº”ç”¨

```cpp
// åœ¨ face_detect_client.cpp ä¸­ï¼š

// ===== æŒ‡é’ˆï¼Œç”¨ -> =====

// 1. client_ æ˜¯ SharedPtrï¼ˆæŒ‡é’ˆï¼‰
rclcpp::Client<...>::SharedPtr client_;
client_->wait_for_service(...)      // ->
client_->async_send_request(request) // ->

// 2. request æ˜¯ make_shared åˆ›å»ºçš„ï¼ˆæŒ‡é’ˆï¼‰
auto request = std::make_shared<...::Request>();
request->image = ...                 // ->

// 3. response æ˜¯ future.get() è¿”å›çš„ï¼ˆæ™ºèƒ½æŒ‡é’ˆï¼‰
auto response = future.get();
response->number                     // ->
response->use_time                   // ->

// ===== æ™®é€šå¯¹è±¡ï¼Œç”¨ . =====

// 4. image æ˜¯æ™®é€šå¯¹è±¡
cv::Mat image = cv::imread(...);
image.empty()                        // .

// 5. gray æ˜¯æ™®é€šå¯¹è±¡
cv::Mat gray;
gray.size()                          // .
```

---

### 10.5 å°æŠ€å·§ï¼šä¸ç¡®å®šæ—¶è®©ç¼–è¯‘å™¨å‘Šè¯‰ä½ 

```cpp
// å¦‚æœä½ ç”¨é”™äº†ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼š

client_.wait_for_service(...)  // âŒ ç¼–è¯‘æŠ¥é”™ï¼
// error: request for member 'wait_for_service' in 'client_',
// which is of pointer type...
// æç¤ºï¼šè¿™æ˜¯æŒ‡é’ˆç±»å‹ï¼Œåº”è¯¥ç”¨ ->

client_->wait_for_service(...) // âœ“ æ­£ç¡®
```

**ç»“è®º**ï¼šä¸ç”¨æ€•å†™é”™ï¼Œç¼–è¯‘å™¨ä¼šæé†’ä½ ï¼

---

### 10.6 ä¸ºä»€ä¹ˆROS2ä»£ç é‡Œè¿™ä¹ˆå¤š -> ï¼Ÿ

å› ä¸ºROS2å¤§é‡ä½¿ç”¨**æ™ºèƒ½æŒ‡é’ˆ**ï¼ˆSharedPtrï¼‰æ¥ç®¡ç†å†…å­˜ï¼š

```cpp
// å‡ ä¹æ‰€æœ‰ROS2å¯¹è±¡éƒ½æ˜¯æ™ºèƒ½æŒ‡é’ˆ
rclcpp::Node::SharedPtr node;
rclcpp::Publisher<...>::SharedPtr publisher_;
rclcpp::Subscription<...>::SharedPtr subscription_;
rclcpp::Service<...>::SharedPtr service_;
rclcpp::Client<...>::SharedPtr client_;

// æ‰€ä»¥ä½ ä¼šçœ‹åˆ°å¾ˆå¤š ->
node->get_logger()
publisher_->publish(msg)
client_->async_send_request(request)
```

---

*å­¦ä¹ ç¬”è®°å®Œæˆäº 2024å¹´*
